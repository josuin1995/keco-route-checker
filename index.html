<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K-eco 플로우 체크</title>
<style>
  /* ---- Default wide layout ---- */
  :root { --gap: 10px; --radius: 12px; --muted:#6b7280; --shadow: 0 10px 20px rgba(0,0,0,.08); }
  body { --page-width: 1680px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background:#f5f7fb; color:#111; }
  header { position: sticky; top:0; z-index: 20; background:#fff; box-shadow: var(--shadow); }
  .wrap { max-width: var(--page-width); margin: 0 auto; padding: 16px 20px; }
  .brandbar { display:flex; align-items:center; gap:12px; }
  .brand-mark { display:flex; align-items:center; gap:10px; padding:8px 10px; }
  .brand-mark img { height:40px; object-fit: contain; }
  .brand-name { display:flex; flex-direction:column; line-height:1.2; }
  .brand-name .org { font-size:13px; color:#374151; }
  .brand-name .app { font-size:20px; font-weight:800; }
  .toolbar, .topbar, .card { border:1px solid #e5e7eb; border-radius: var(--radius); background:#fff; }
  main .wrap { display: grid; gap: 16px; }
  .toolbar, .topbar { padding: 12px; }
  .card { padding: 12px; }
  .row { display:flex; gap:var(--gap); align-items:center; flex-wrap:nowrap; overflow:auto; } /* 한줄 배치 */
  select, input[type="text"], input[type="date"], input[type="url"], input[type="tel"] { padding: 8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
  button { padding: 8px 12px; border:1px solid #cfcfcf; border-radius:8px; background:#f6f6f6; cursor:pointer; }
  /* anchor style buttons */
  a.btn { display:inline-flex; align-items:center; gap:8px; padding: 10px 14px; border-radius:10px; border:1px solid transparent; text-decoration:none; font-weight:600; }
  a.btn:hover { text-decoration:none; }
  .btn-accent { 
    background: linear-gradient(135deg, #22c55e, #10b981);
    color:#fff; border-color: #0ea5e9; 
    box-shadow: 0 10px 20px rgba(16,185,129,.22);
    transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
  }
  .btn-accent:hover { transform: translateY(-1px); box-shadow: 0 14px 26px rgba(16,185,129,.28); filter: brightness(0.98); }
  button.primary { border-color:#111; background:#111; color:#fff; }
  table { width:100%; border-collapse: collapse; background:#fff; table-layout: auto; }
  th, td { border-bottom:1px solid #eee; padding: 10px; text-align:left; vertical-align: middle; }
  th { font-weight:600; background:#f4f6f8; white-space: nowrap; }
  /* 제목 칸은 한 줄로 보이되 길면 말줄임표 */
  .cell-title { max-width: 460px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; border:1px solid #e5e7eb; background:#fafafa; }
  .muted { color: var(--muted); font-size: 12px; }
  .note { font-size:12px; color:#6b7280; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:12px; }
  .chip .dd { font-weight:700; }
  .chip.warn { background:#fff5f5; border-color:#f5c2c2; }
  .chip.ok { background:#f0fff4; border-color:#8fd19e; }
  .chip.err { background:#fff5f5; border-color:#f5c2c2; }
  .footer { margin-top:16px; font-size:12px; color:#374151; display:flex; gap:24px; flex-wrap:wrap; }
  .footer .box { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
  .left { flex:1; }
  .right { display:flex; gap:8px; }
  .sep { width:1px; height:20px; background:#e5e7eb; }
  .tip { position: relative; display:inline-block; cursor: help; }
  .tip::after {
    content: attr(data-tip);
    position: absolute;
    left: 0;
    bottom: 120%;
    min-width: 240px;
    max-width: 360px;
    padding: 8px 10px;
    border-radius: 8px;
    background: #111;
    color:#fff;
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    box-shadow: 0 6px 20px rgba(0,0,0,.15);
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity .15s ease, transform .15s ease;
    z-index: 10;
  }
  .tip:focus::after, .tip:hover::after { opacity: 1; transform: translateY(0); }
  /* 자료실 */
  .docs { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
  .doc { display:flex; gap:12px; padding:14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .doc .ico { font-size:26px; }
  .doc .title { font-weight:800; }
  .doc .desc { font-size:12px; color:#6b7280; }
  .doc .actions a { display:inline-block; margin-right:8px; text-decoration:none; border:1px solid #e5e7eb; padding:6px 10px; border-radius:10px; font-size:12px; font-weight:700; }
  /* accent inline link */
  a.link-accent { 
    color:#0f766e; 
    font-weight:800; 
    text-decoration:none; 
    background: linear-gradient(transparent 75%, rgba(16,185,129,.25) 0);
    border-radius:6px; padding: 0 2px;
    transition: filter .12s ease;
  }
  a.link-accent:hover { text-decoration: underline; filter: brightness(0.98); }

  /* === 3줄 알림(토스트) 스타일 === */
  #three-line-alerts {
    position: fixed;
    right: 16px;
    bottom: 16px;
    display: grid;
    gap: 10px;
    max-width: 380px;
    z-index: 9999;
    pointer-events: none;
  }
  .tla {
    pointer-events: auto;
    background: #ffffff;
    border: 1px solid rgba(0,0,0,0.06);
    border-radius: 14px;
    padding: 14px 14px 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    transition: transform .2s ease, opacity .2s ease;
    opacity: 0; transform: translateY(8px);
    font-family: system-ui, -apple-system, "Noto Sans KR", Segoe UI, Roboto, Arial, sans-serif;
  }
  .tla.show { opacity: 1; transform: translateY(0); }
  .tla-line1 { font-weight: 700; font-size: 15px; margin-bottom: 6px; }
  .tla-line2, .tla-line3 { font-size: 13px; color: #333; line-height: 1.35; }
  .tla-row { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-top: 10px; }
  .tla-btns { display: flex; gap: 6px; }
  .tla button { border: 0; border-radius: 10px; padding: 6px 10px; background: #f3f4f6; cursor: pointer; font-size: 12px; }
  .tla button:hover { background: #e5e7eb; }
  .tla[data-type="success"] { border-color: #16a34a26; }
  .tla[data-type="info"]    { border-color: #2563eb26; }
  .tla[data-type="warn"]    { border-color: #f59e0b26; }

  /* === Column sizing (연두 축소, 노랑 확대) === */
  th.col-title, td.col-title { width: 18%; min-width: 280px; }
  th.col-role, td.col-role   { width: 8%;  min-width: 120px; }
  th.col-emit, td.col-emit   { width: 10%; min-width: 130px; }
  th.col-manager, td.col-manager { width: 7%;  min-width: 110px; } /* 연두 좁게 */
  th.col-phone, td.col-phone { width: 9%;  min-width: 140px; }    /* 연두 좁게 */
  th.col-recv, td.col-recv   { width: 14%; min-width: 240px; }    /* 노랑 넓게 */
  th.col-due, td.col-due     { width: 12%; min-width: 210px; }    /* 노랑 넓게 */
  th.col-proc, td.col-proc   { width: 10%; min-width: 160px; }    /* 노랑 넓게 */
  th.col-levyapp, td.col-levyapp { width: 11%; min-width: 170px; }/* 노랑 넓게 */
  th.col-levy, td.col-levy   { width: 10%; min-width: 160px; }    /* 노랑 넓게 */
  th.col-status, td.col-status{ width: 12%; min-width: 180px; }   /* 노랑 넓게 */
  th.col-del, td.col-del     { width: 5%;  min-width: 72px; text-align: right; }

  /* === Title autosuggest === */
  .sugg-wrap { position: relative; display: inline-block; }
  #titleSuggest {
    position: absolute; left: 0; top: calc(100% + 4px); min-width: 260px;
    max-height: 260px; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:10px;
    box-shadow: 0 12px 28px rgba(0,0,0,.12); padding:6px; z-index: 30; display:none;
  }
  .sug-item { padding:8px 10px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; gap:10px; }
  .sug-item:hover, .sug-item.active { background:#f4f6f8; }
  .sug-title { max-width: 420px; white-space: nowrap; overflow:hidden; text-overflow:ellipsis; }
  .sug-meta { color:#6b7280; font-size:12px; white-space:nowrap; }
</style>
</head>
<body>
  <header>
    <div class="wrap brandbar">
      <div class="brand-mark">
        <img src="assets/img/keco_logo.png" alt="K-eco 로고" />
        <div class="brand-name">
          <div class="org">한국환경공단</div>
          <div class="app">K-eco 플로우 체크</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- 상단: 사용자 전환 + 내보내기 + 저장 -->
      <div class="topbar">
        <div class="row">
          <div class="left row">
            <label class="row" style="gap:6px;">
              <span class="muted">사용자 ID</span>
              <input id="userId" type="text" placeholder="예: 회사명_담당자 또는 사번" style="min-width:220px">
            </label>
            <button id="switchUser">열기/전환</button>
            <span id="saveState" class="muted">미선택</span>
            <div class="sep"></div>
          </div>
          <div class="right row">
            <button id="exportBtn">내보내기(JSON)</button>
            <button id="saveBtn" class="primary">저장하기</button>
          </div>
        </div>
      </div>

      <!-- D-day 한눈에 -->
      <div class="card" style="margin:0;">
        <div class="row" id="ddayRow" style="gap:12px;"></div>
      </div>

      <!-- 입력/추가 툴바 -->
      <div class="toolbar">
        <div class="row">
          <div class="sugg-wrap">
            <input id="titleInput" type="text" placeholder="제목 (예: 2025-08-12 A공장 혼합폐기물)" style="min-width:420px">
            <div id="titleSuggest" role="listbox" aria-label="이전 내역"></div>
          </div>
          <select id="roleInput" title="역할 선택">
            <option value="carrier">운반업체</option>
            <option value="processor">처리업체</option>
            <option value="both" selected>운반+처리</option>
          </select>
          <button id="addBtn" class="btn primary">새 건 추가</button>
          <span class="muted">※ 제목 입력 → 아래 제안 클릭 또는 Enter로 추가</span>
        </div>
      </div>

      <!-- 리스트 -->
      <div class="card">
        <table id="listTable">
          <thead>
            <tr>
              <th class="col-title">제목</th>
              <th class="col-role">역할</th>
              <th class="col-emit">배출일</th>
              <th class="col-manager">담당자</th>
              <th class="col-phone">연락처</th>
              <th class="col-recv">인수완료<div class="muted">(체크 시 인수일 저장)</div></th>
              <th class="col-due"><span class="tip" tabindex="0" data-tip="참고: 폐기물관리법 시행규칙 제31조 (최신 법령 확인 권장)">폐기물처리기한 ⓘ</span><div class="note">처리자만 수정 가능</div></th>
              <th class="col-proc">처리완료</th>
              <th class="col-levyapp"><span class="tip" tabindex="0" data-tip="폐기물처분부담금은 소각·매립 등 최종 처분량에 부과되는 부담금입니다. (모든 폐기물이 대상은 아님)&#10;※ 건설공사 등 대상의 경우 보통 '준공일 후 30일 이내' 신고 필요(기관 지침/법령 확인 요망).">처분부담금 해당여부 ⓘ</span><div class="note">미확인/해당/비해당</div></th>
              <th class="col-levy">폐기물처분부담금</th>
              <th class="col-status">상태</th>
              <th class="col-del"></th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>

      <!-- 자료실 + 진단 -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <h3 style="margin:0 0 8px 0;">자료실</h3>
          <div class="right row">
            <button id="diagBtn" title="assets/pdf 내부 파일 존재 여부를 점검합니다.">자료 파일 진단</button>
            <div id="diagArea" class="row"></div>
          </div>
        </div>
        <div class="docs">
          <div class="doc">
            <div class="ico">📘</div>
            <div style="flex:1;">
              <div class="title">올바로시스템 매뉴얼</div>
              <div class="desc">회원가입 → 인계서작성 → 대장관리 → 실적보고</div>
              <div class="actions">
                <a href="assets/pdf/allbaro_manual_2025.pdf" target="_blank" rel="noopener">보기</a>
                <a href="assets/pdf/allbaro_manual_2025.pdf" download>다운로드</a>
              </div>
            </div>
          </div>
          <div class="doc">
            <div class="ico">📙</div>
            <div style="flex:1;">
              <div class="title">폐기물처분부담금 매뉴얼</div>
              <div class="desc">부담금 산정 · 감면 · 신고/납부 · 온라인 신고 절차</div>
              <div class="actions">
                <a href="assets/pdf/levy_booklet_2025.pdf" target="_blank" rel="noopener">보기</a>
                <a href="assets/pdf/levy_booklet_2025.pdf" download>다운로드</a>
              </div>
            </div>
          </div>
        </div>
        <div class="muted" style="font-size:12px;margin-top:8px;">※ 파일명이 영문/숫자만이라 경로 문제를 최소화했습니다.</div>
      </div>

      <!-- 사전계산/재활용 안내 버튼 -->
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <div>
            <h3 style="margin:0 0 4px 0;">
              <a class="link-accent" href="levy_calc.html" target="_self" rel="noopener">
                폐기물처분부담금 사전계산 · 재활용 안내 바로가기
              </a>
            </h3>
            <div class="muted">예상 부담금 계산, 재활용 처리업체 지도 확인 기능</div>
          </div>
        </div>
      </div>
      <!-- 연락처 -->
      <div class="footer">
        <div class="box">올바로시스템 문의: <b>062-949-0754</b></div>
        <div class="box">폐기물처분부담금 문의: <b>062-949-0305</b></div>
      </div>
    </div>
  </main>

  <!-- === 3줄 알림 컨테이너 === -->
  <div id="three-line-alerts" aria-live="polite" aria-atomic="true"></div>

  <!-- === 3줄 알림 유틸 + 3가지 API + 저장 알림 === -->
  <script>
  (function () {
    function addDaysAbs(date, days) {
      if(!date) return null;
      const d = new Date(date); d.setDate(d.getDate() + Number(days || 0)); return d;
    }
    function fmtKDate(date) {
      if(!date) return '-';
      const d = new Date(date);
      return new Intl.DateTimeFormat('ko-KR', { year:'numeric', month:'2-digit', day:'2-digit', weekday:'short' }).format(d);
    }

    const host = document.getElementById('three-line-alerts');
    function threeLineAlert({ line1, line2, line3, type = 'info', timeout = 7000 }) {
      if (!host) return;
      const wrap = document.createElement('div');
      wrap.className = 'tla'; wrap.dataset.type = type;

      const l1 = document.createElement('div'); l1.className = 'tla-line1'; l1.textContent = line1 || '';
      const l2 = document.createElement('div'); l2.className = 'tla-line2'; l2.textContent = line2 || '';
      const l3 = document.createElement('div'); l3.className = 'tla-line3'; l3.textContent = line3 || '';

      const row = document.createElement('div'); row.className = 'tla-row';
      const btns = document.createElement('div'); btns.className = 'tla-btns';
      const btnCopy = document.createElement('button'); btnCopy.type='button'; btnCopy.textContent='복사';
      btnCopy.addEventListener('click', async () => {
        const text = [line1, line2, line3].filter(Boolean).join('\\n');
        try { await navigator.clipboard.writeText(text); btnCopy.textContent='복사됨'; setTimeout(()=>btnCopy.textContent='복사', 1200);} catch {}
      });
      const btnClose = document.createElement('button'); btnClose.type='button'; btnClose.textContent='닫기';
      btnClose.addEventListener('click', () => destroy());
      btns.append(btnCopy, btnClose); row.append(document.createElement('span'), btns);

      wrap.append(l1, l2, l3, row); host.appendChild(wrap);
      requestAnimationFrame(() => wrap.classList.add('show'));
      let to = null; if (timeout > 0) to = setTimeout(destroy, timeout);
      function destroy(){ if(to) clearTimeout(to); wrap.classList.remove('show'); wrap.addEventListener('transitionend', ()=>wrap.remove(), { once:true }); }
      return { destroy };
    }

    // 1) 배출 등록 시
    window.notifyEmissionRegistered = function ({ emissionDate, contactName, contactPhone, title = '배출 등록' } = {}) {
      const deadline = addDaysAbs(emissionDate, 2);
      const line1 = title;
      const line2 = deadline ? \`인수기한: \${fmtKDate(deadline)} (배출일 + 2일)\` : '인수기한: -';
      const contact = [contactName, contactPhone].filter(Boolean).join(' / ');
      const line3 = contact ? \`연락처: \${contact}\` : '연락처: -';
      return threeLineAlert({ line1, line2, line3, type: 'info' });
    };

    // 2) 인수 완료 시
    window.notifyPickupCompleted = function ({ pickupDate, processingDeadline, title = '인수 완료' } = {}) {
      const line1 = \`\${title}: \${fmtKDate(pickupDate)}\`;
      const line2 = processingDeadline ? \`처리기한: \${fmtKDate(processingDeadline)}\` : '처리기한: -';
      const line3 = '일정 공유되었습니다.';
      return threeLineAlert({ line1, line2, line3, type: 'success' });
    };

    // 3) 처리/준공 완료 시
    window.notifyProcessingCompleted = function ({ completionDate, levyApplicable, title = '처리/준공 완료' } = {}) {
      const line1 = title;
      const line2 = \`처분부담금 해당: \${levyApplicable ? '예' : '아니오'}\`;
      const due = addDaysAbs(completionDate, 30);
      const line3 = due ? \`납부기한: \${fmtKDate(due)} (준공 후 30일)\` : '납부기한: -';
      return threeLineAlert({ line1, line2, line3, type: levyApplicable ? 'warn' : 'info' });
    };

    // 4) 수동 저장 알림
    window.notifySaved = function (count) {
      return threeLineAlert({
        line1: '저장 완료',
        line2: '현재 항목 수: ' + (count ?? '-'),
        line3: '브라우저에 자동 저장되며, 필요시 JSON 내보내기가 가능합니다.',
        type: 'success'
      });
    };
  })();
  </script>

<script>
// ---------- Storage (per-user) ----------
function storageAvailable() {
  try { var x='__t__'+Math.random(); localStorage.setItem(x,'1'); localStorage.removeItem(x); return true; } catch(e){ return false; }
}
var STORAGE_OK = storageAvailable();
var BASE_KEY = 'mini_route_checker_items_v71_with_calcbtn';
var CUR_USER = '';        // BLANK by default
var STATE = [];           // no preloaded data

function keyFor(user){ return BASE_KEY + '::' + (user||'default'); }
function load(user){
  if(!STORAGE_OK){ return []; }
  try { return JSON.parse(localStorage.getItem(keyFor(user)) || '[]'); } catch(e){ return []; }
}
function save(){
  var el = document.getElementById('saveState');
  if(!STORAGE_OK){ el.textContent = '저장 불가(임시)'; return; }
  try { localStorage.setItem(keyFor(CUR_USER), JSON.stringify(STATE)); el.textContent = '자동저장됨'; }
  catch(e){ el.textContent = '저장 오류'; }
}
async function switchUser(){
  var id = document.getElementById('userId').value.trim();
  if(!id){ alert('사용자 ID를 입력하세요.'); document.getElementById('userId').focus(); return; }
  CUR_USER = id;
  // 로컬 우선
  STATE = load(CUR_USER);
  if(STATE.length>0){
    document.getElementById('saveState').textContent = '로컬 불러옴';
  } else {
    STATE = [];
    document.getElementById('saveState').textContent = '신규 사용자(빈 목록)';
  }
  render();
}

// ---------- Date helpers ----------
function uuid(){ return (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8); }
function todayStr(){ var d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(s){ if(!s) return null; var d=new Date(s); d.setHours(0,0,0,0); return d; }
function addDays(s,n){ var d=toDate(s); if(!d) return null; d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function ddayLabel(target){ 
  if(!target) return '-';
  var t = toDate(target), today = toDate(todayStr());
  var delta = Math.floor((t - today)/86400000);
  if (delta > 0) return 'D-' + delta;
  if (delta === 0) return 'D-DAY';
  return 'D+' + Math.abs(delta);
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(ch){ return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]); }); }

// ---------- D-day summary (부담금은 '준공일+30') ----------
function renderDday(){
  var row = document.getElementById('ddayRow');
  if(!CUR_USER){
    row.innerHTML = '<span class="chip"><span>사용자 선택 필요</span></span>';
    return;
  }
  // 인수 D-day (배출일 +2, 미인수건 중 최우선)
  var receiptCandidates = STATE.filter(x=> !x.received_done && x.emit_date)
    .map(x=> ({ id:x.id, title:x.title, due: addDays(x.emit_date, 2) }))
    .filter(o=>!!o.due);
  receiptCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var rec = receiptCandidates.length ? receiptCandidates[0] : null;

  // 처리 D-day (처리기한, 미처리건 중 최우선)
  var procCandidates = STATE.filter(x=> !x.processed_done && x.due_date)
    .map(x=> ({ id:x.id, title:x.title, due:x.due_date }));
  procCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var pro = procCandidates.length ? procCandidates[0] : null;

  // 부담금 D-day (해당 + 미확인완료 + 준공일 존재 => 준공+30일)
  var levyCandidates = STATE
    .filter(x => x.levy_applicable === '해당' && !x.levy_done && !!x.completion_date)
    .map(x => ({ id:x.id, title:x.title, due: addDays(x.completion_date, 30) }))
    .filter(o=>!!o.due);
  levyCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var lev = levyCandidates.length ? levyCandidates[0] : null;

  function chip(label, obj, warnIfPast=true){
    if(!obj) return '<span class="chip"><span>'+label+'</span><span class="dd">-</span></span>';
    var dd = ddayLabel(obj.due);
    var warn = warnIfPast ? (toDate(obj.due) - toDate(todayStr())) < 0 : false;
    return '<span class="chip '+(warn?'warn':'ok')+'"><span>'+label+'</span><span class="dd">'+dd+'</span><span class="muted">('+escapeHtml(obj.title)+')</span></span>';
  }

  row.innerHTML = chip('인수 D-day', rec) + chip('처리 D-day', pro) + chip('부담금 D-day', lev);
}

// ---------- Title autosuggest ----------
function uniqueTitles(){
  const seen = new Set(); const out = [];
  STATE.forEach(x=>{ const t=(x.title||'').trim(); if(t && !seen.has(t)){ seen.add(t); out.push({title:t, role:x.role||'', emit:x.emit_date||''}); } });
  return out; // 최근 순서(STATE는 최신이 앞)
}
function filterTitles(q){
  const all = uniqueTitles();
  if(!q) return all.slice(0, 10);
  const qq = q.toLowerCase();
  const starts = []; const contains = [];
  all.forEach(o=>{
    const tt = o.title.toLowerCase();
    if(tt.startsWith(qq)) starts.push(o);
    else if(tt.includes(qq)) contains.push(o);
  });
  return starts.concat(contains).slice(0,10);
}
function showTitleSuggest(list){
  const box = document.getElementById('titleSuggest');
  const input = document.getElementById('titleInput');
  if(!box) return;
  if(!list || list.length===0){ box.style.display='none'; box.innerHTML=''; return; }
  box.style.minWidth = input.offsetWidth + 'px';
  box.innerHTML = list.map((o,i)=> '<div class="sug-item" data-idx="'+i+'"><div class="sug-title">'+escapeHtml(o.title)+'</div><div class="sug-meta">'+(o.emit?('배출 '+o.emit):'')+'</div></div>').join('');
  box.style.display = 'block';
  let active = -1;
  function setActive(n){
    const items = box.querySelectorAll('.sug-item');
    items.forEach(el=>el.classList.remove('active'));
    if(n>=0 && n<items.length){ items[n].classList.add('active'); active=n; }
  }
  box.onmousedown = function(e){
    const item = e.target.closest('.sug-item');
    if(item){
      const idx = Number(item.dataset.idx||0);
      input.value = list[idx].title;
      setTimeout(()=>{ box.style.display='none'; }, 0);
    }
  };
  input.onkeydown = function(e){
    const items = box.querySelectorAll('.sug-item');
    if(e.key==='ArrowDown'){ e.preventDefault(); setActive(Math.min(active+1, items.length-1)); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); setActive(Math.max(active-1, 0)); }
    else if(e.key==='Enter'){
      if(active>=0){ e.preventDefault(); input.value = list[active].title; box.style.display='none'; }
    } else if(e.key==='Escape'){ box.style.display='none'; }
  };
  input.onblur = function(){ setTimeout(()=>{ box.style.display='none'; }, 150); };
}
function handleTitleInput(){
  const v = document.getElementById('titleInput').value.trim();
  const list = filterTitles(v);
  showTitleSuggest(list);
}

// ---------- Table rendering ----------
function render(){
  renderDday();
  var body = document.getElementById('listBody');
  body.innerHTML = '';

  STATE.forEach(function(x){
    var tr = document.createElement('tr');

    var tdTitle = document.createElement('td'); tdTitle.className='col-title';
    tdTitle.innerHTML = '<div class=\"cell-title\">'+escapeHtml(x.title)+'</div><div class=\"muted\">'+escapeHtml(x.id)+'</div>';
    tr.appendChild(tdTitle);

    var tdRole = document.createElement('td'); tdRole.className='col-role';
    var roleSel = document.createElement('select');
    [['carrier','운반업체'],['processor','처리업체'],['both','운반+처리']].forEach(function(pair){
      var op = document.createElement('option'); op.value = pair[0]; op.textContent = pair[1]; roleSel.appendChild(op);
    });
    roleSel.value = x.role || 'carrier';
    roleSel.onchange = function(e){ x.role = e.target.value; save(); render(); };
    tdRole.appendChild(roleSel);
    tr.appendChild(tdRole);

    var tdEmit = document.createElement('td'); tdEmit.className='col-emit';
    var emit = document.createElement('input');
    emit.type='date'; emit.value = x.emit_date || '';
    emit.onchange = function(e){
      var before = x.emit_date || '';
      x.emit_date = e.target.value;
      save(); render();
      if(!before && x.emit_date){
        window.notifyEmissionRegistered({ 
          emissionDate: x.emit_date,
          contactName: x.contact_name || '',
          contactPhone: x.contact_phone || ''
        });
      }
    };
    tdEmit.appendChild(emit);
    tr.appendChild(tdEmit);

    // 담당자 (연두: 좁게)
    var tdManager = document.createElement('td'); tdManager.className='col-manager';
    var manager = document.createElement('input');
    manager.type = 'text'; manager.placeholder = '담당자명'; manager.value = x.contact_name || '';
    manager.style.width = '120px';
    manager.onchange = function(e){ x.contact_name = e.target.value; save(); };
    tdManager.appendChild(manager);
    tr.appendChild(tdManager);

    // 연락처 (연두: 좁게)
    var tdPhone = document.createElement('td'); tdPhone.className='col-phone';
    var phone = document.createElement('input');
    phone.type='tel'; phone.placeholder='010-0000-0000'; phone.value = x.contact_phone || '';
    phone.style.width = '140px';
    phone.onchange = function(e){ x.contact_phone = e.target.value; save(); };
    tdPhone.appendChild(phone);
    tr.appendChild(tdPhone);

    // 인수완료 (노랑: 넓게)
    var tdRecv = document.createElement('td'); tdRecv.className='col-recv';
    var recvWrap = document.createElement('label'); recvWrap.style.display='inline-flex'; recvWrap.style.alignItems='center'; recvWrap.style.gap='6px';
    var recv = document.createElement('input'); recv.type='checkbox'; recv.checked = !!x.received_done;
    recv.onchange = function(e){
      var was = !!x.received_done;
      x.received_done = !!e.target.checked;
      if(x.received_done){ x.received_at = x.received_at || todayStr(); }
      else { x.received_at = null; }
      save(); render();
      if(!was && x.received_done){
        window.notifyPickupCompleted({ pickupDate: x.received_at, processingDeadline: x.due_date || null });
      }
    };
    var recvSpan = document.createElement('span'); recvSpan.textContent = '인수완료';
    recvWrap.appendChild(recv); recvWrap.appendChild(recvSpan);
    tdRecv.appendChild(recvWrap);

    if(x.received_done){
      var recvDate = document.createElement('input'); recvDate.type='date'; recvDate.value = x.received_at || todayStr();
      recvDate.onchange = function(e){ x.received_at = e.target.value; save(); render(); };
      recvDate.style.marginLeft='8px'; tdRecv.appendChild(recvDate);
      if(x.emit_date){
        var due = addDays(x.emit_date, 2);
        if(due){
          var late = (toDate(x.received_at||todayStr()) - toDate(due)) > 0;
          var note = document.createElement('div'); note.className='note';
          note.textContent = '인수기한: '+due + (late ? ' (지연)' : '');
          tdRecv.appendChild(note);
        }
      }
    }
    tr.appendChild(tdRecv);

    // 처리기한 (노랑: 넓게)
    var tdDue = document.createElement('td'); tdDue.className='col-due';
    var dueInput = document.createElement('input');
    dueInput.type='date'; dueInput.value = x.due_date || '';
    dueInput.onchange = function(e){ x.due_date = e.target.value; save(); render(); };
    var canEditDue = (x.role==='processor' || x.role==='both');
    if(!canEditDue){ dueInput.disabled = true; dueInput.title='처리자만 수정 가능'; }
    tdDue.appendChild(dueInput);
    if(!canEditDue){
      var helper = document.createElement('div'); helper.className='note';
      helper.textContent = '역할을 처리업체/운반+처리로 바꾸면 수정 가능';
      tdDue.appendChild(helper);
    }
    tr.appendChild(tdDue);

    // 처리완료 (노랑: 넓게)
    var tdProc = document.createElement('td'); tdProc.className='col-proc';
    var procWrap = document.createElement('label'); 
    procWrap.style.display='inline-flex'; 
    procWrap.style.alignItems='center'; 
    procWrap.style.gap='6px';
    var proc = document.createElement('input'); proc.type='checkbox'; proc.checked = !!x.processed_done;
    proc.onchange = function(e){
      var was = !!x.processed_done;
      x.processed_done = !!e.target.checked;
      if(x.processed_done){ x.processed_at = x.processed_at || todayStr(); }
      else { x.processed_at = null; }
      save(); render();
      if(!was && x.processed_done){
        var levyApplicable = (x.levy_applicable === '해당');
        window.notifyProcessingCompleted({ completionDate: x.completion_date || x.processed_at, levyApplicable: levyApplicable });
      }
    };
    var procSpan = document.createElement('span'); procSpan.textContent = '처리완료';
    procWrap.appendChild(proc); procWrap.appendChild(procSpan);
    tdProc.appendChild(procWrap);
    tr.appendChild(tdProc);

    // 처분부담금 해당여부 (노랑: 넓게) + (해당이면 준공일 입력 노출)
    var tdApplicable = document.createElement('td'); tdApplicable.className='col-levyapp';
    var sel = document.createElement('select');
    ['미확인','해당','비해당'].forEach(function(v){ var op=document.createElement('option'); op.value=v; op.textContent=v; sel.appendChild(op); });
    sel.value = x.levy_applicable || '미확인';
    sel.onchange = function(e){ 
      x.levy_applicable = e.target.value; 
      if(x.levy_applicable!=='해당'){ x.levy_done=false; x.completion_date=''; }
      save(); render(); 
    };
    tdApplicable.appendChild(sel);
    // 준공일 입력(해당일 때 표시)
    if(x.levy_applicable === '해당'){
      var comp = document.createElement('input');
      comp.type='date'; comp.value = x.completion_date || ''; comp.placeholder='준공일';
      comp.style.marginLeft='8px';
      comp.setAttribute('aria-label','준공일');
      var compWrap = document.createElement('label');
      compWrap.style.display='inline-flex';
      compWrap.style.alignItems='center';
      compWrap.style.gap='6px';
      var compText = document.createElement('span'); compText.textContent='준공일';
      comp.onchange = function(e){ x.completion_date = e.target.value; save(); render(); };
      compWrap.appendChild(compText);
      compWrap.appendChild(comp);
      tdApplicable.appendChild(compWrap);
      if(x.completion_date){
        var due30 = addDays(x.completion_date, 30);
        var note2 = document.createElement('div'); note2.className='note';
        note2.textContent = '납부기한(준공+30): ' + (due30 || '-');
        tdApplicable.appendChild(note2);
      }
    }
    tr.appendChild(tdApplicable);

    // 폐기물처분부담금 (노랑: 넓게)
    var tdLevy = document.createElement('td'); tdLevy.className='col-levy';
    var wrap = document.createElement('div'); var disabled = x.levy_applicable!=='해당'; wrap.style.opacity = disabled ? .45 : 1;
    var levy = document.createElement('label'); levy.style.display='inline-flex'; levy.style.alignItems='center'; levy.style.gap='6px';
    var levyBox = document.createElement('input'); levyBox.type='checkbox'; levyBox.checked = !!x.levy_done; levyBox.disabled = disabled;
    levyBox.onchange = function(e){ x.levy_done = !!e.target.checked; save(); render(); };
    var levySpan = document.createElement('span'); levySpan.textContent = '확인완료';
    levy.appendChild(levyBox); levy.appendChild(levySpan); wrap.appendChild(levy);
    tdLevy.appendChild(wrap);
    tr.appendChild(tdLevy);

    // 상태 (노랑: 넓게)
    var tdStatus = document.createElement('td'); tdStatus.className='col-status';
    tdStatus.innerHTML = statusText(x);
    tr.appendChild(tdStatus);

    // 삭제
    var tdDel = document.createElement('td'); tdDel.className='col-del';
    var del = document.createElement('button'); del.textContent = '삭제'; del.onclick = function(){ STATE = STATE.filter(i=> i.id!==x.id); save(); render(); };
    tdDel.appendChild(del);
    tr.appendChild(tdDel);

    body.appendChild(tr);
  });
}

function statusText(x){
  var recDue = x.emit_date ? addDays(x.emit_date, 2) : null;
  var recDD = (!x.received_done && recDue) ? ddayLabel(recDue) : null;
  var proDD = (!x.processed_done && x.due_date) ? ddayLabel(x.due_date) : null;
  // 부담금은 준공일+30 기준
  var levyDue = (x.levy_applicable==='해당' && !x.levy_done && x.completion_date) ? ddayLabel(addDays(x.completion_date, 30)) : null;
  var parts = [];
  if(recDD){ parts.push('<span class="pill">인수 '+recDD+'</span>'); }
  if(proDD){ parts.push('<span class="pill">처리 '+proDD+'</span>'); }
  if(levyDue){ parts.push('<span class="pill">부담금 '+levyDue+'</span>'); }
  if(!parts.length) parts.push('<span class="muted">-</span>');
  return parts.join(' ');
}

// ---------- Docs diagnostics ----------
async function checkFile(url){
  try{
    // Try HEAD first; if blocked, fallback to GET
    let res = await fetch(url, { method:'HEAD' });
    if(!res.ok){ res = await fetch(url, { method:'GET' }); }
    return res.ok;
  }catch(e){ return false; }
}
async function runDiag(){
  const area = document.getElementById('diagArea');
  area.innerHTML = '<span class="muted">점검 중...</span>';
  const files = [
    ['올바로', 'assets/pdf/allbaro_manual_2025.pdf'],
    ['부담금', 'assets/pdf/levy_booklet_2025.pdf'],
  ];
  const results = await Promise.all(files.map(f => checkFile(f[1])));
  area.innerHTML = files.map((f,i)=> '<span class="chip '+(results[i]?'ok':'err')+'"><b>'+f[0]+'</b> '+(results[i]?'있음 ✅':'없음 ❌')+'</span>').join(' ');
}

// ---------- Export ----------
function exportJson(){
  if(!CUR_USER){ alert('먼저 사용자 ID를 입력하고 열어주세요.'); return; }
  var blob = new Blob([JSON.stringify({ user: CUR_USER, data: STATE }, null, 2)], {type:'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'route_checker_'+CUR_USER+'_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ---------- Init ----------
document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('switchUser').addEventListener('click', switchUser);
  document.getElementById('exportBtn').addEventListener('click', exportJson);
  document.getElementById('diagBtn').addEventListener('click', runDiag);

  // 수동 저장 버튼 (자동저장 외에 가시적 저장)
  document.getElementById('saveBtn').addEventListener('click', function(){
    save();
    window.notifySaved(STATE.length);
  });

  // Title autosuggest events
  const t = document.getElementById('titleInput');
  t.addEventListener('input', handleTitleInput);
  t.addEventListener('focus', handleTitleInput);

  // Require user ID first
  document.getElementById('userId').addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); switchUser(); } });

  // Add flow
  var addBtn = document.getElementById('addBtn');
  var title = document.getElementById('titleInput');
  var role = document.getElementById('roleInput');
  function add(){
    if(!CUR_USER){ alert('먼저 사용자 ID를 입력하고 열어주세요.'); return; }
    var v = title.value.trim();
    if(!v){ alert('제목을 입력하세요.'); title.focus(); return; }
    STATE.unshift({
      id: (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-'+Date.now(),
      title: v, role: role.value,
      contact_name: '',
      contact_phone: '',
      emit_date: '', received_done:false, received_at:null,
      due_date: '', processed_done:false, processed_at:null,
      completion_date: '', // 준공일
      levy_applicable:'미확인', levy_done:false, levy_at:null
    });
    save(); title.value=''; render();
    handleTitleInput(); // 새로고침
  }
  addBtn.addEventListener('click', add);
  title.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); add(); } });

  render(); // shows "사용자 선택 필요"
});
</script>
</body>
</html>
