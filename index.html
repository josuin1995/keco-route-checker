<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K-eco í”Œë¡œìš° ì²´í¬</title>
<style>
  :root { --gap: 10px; --radius: 12px; --muted:#6b7280; --shadow: 0 10px 20px rgba(0,0,0,.08); }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background:#f5f7fb; color:#111; }
  header { position: sticky; top:0; z-index: 20; background:#fff; box-shadow: var(--shadow); }
  .wrap { max-width: 1400px; margin: 0 auto; padding: 16px 24px; } /* ë„“ê²Œ */
  .brandbar { display:flex; align-items:center; gap:12px; }
  .brand-mark { display:flex; align-items:center; gap:10px; padding:8px 10px; }
  .brand-mark img { height:44px; object-fit: contain; }
  .brand-name { display:flex; flex-direction:column; line-height:1.2; }
  .brand-name .org { font-size:13px; color:#374151; }
  .brand-name .app { font-size:22px; font-weight:800; }
  .toolbar, .topbar, .card { border:1px solid #e5e7eb; border-radius: var(--radius); background:#fff; }
  main .wrap { display: grid; gap: 16px; }
  .toolbar, .topbar { padding: 12px; }
  .card { padding: 12px; }
  .row { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
  select, input[type="text"], input[type="date"], input[type="url"], input[type="number"] { padding: 8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
  button { padding: 8px 12px; border:1px solid #cfcfcf; border-radius:8px; background:#f6f6f6; cursor:pointer; }
  button.primary { border-color:#111; background:#111; color:#fff; }
  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { border-bottom:1px solid #eee; padding: 10px; text-align:left; vertical-align: middle; }
  th { font-weight:600; background:#f4f6f8; }
  .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; border:1px solid #e5e7eb; background:#fafafa; }
  .muted { color: var(--muted); font-size: 12px; }
  .note { font-size:12px; color:#6b7280; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:12px; }
  .chip .dd { font-weight:700; }
  .chip.warn { background:#fff5f5; border-color:#f5c2c2; }
  .chip.ok { background:#f0fff4; border-color:#8fd19e; }
  .chip.err { background:#fff5f5; border-color:#f5c2c2; }
  .footer { margin-top:16px; font-size:12px; color:#374151; display:flex; gap:24px; flex-wrap:wrap; }
  .footer .box { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
  .left { flex:1; }
  .right { display:flex; gap:8px; }
  .sep { width:1px; height:20px; background:#e5e7eb; }
  .tip { position: relative; display:inline-block; cursor: help; }
  .tip::after {
    content: attr(data-tip);
    position: absolute;
    left: 0;
    bottom: 120%;
    min-width: 240px;
    max-width: 360px;
    padding: 8px 10px;
    border-radius: 8px;
    background: #111;
    color:#fff;
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    box-shadow: 0 6px 20px rgba(0,0,0,.15);
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity .15s ease, transform .15s ease;
    z-index: 10;
  }
  .tip:focus::after, .tip:hover::after { opacity: 1; transform: translateY(0); }
  /* ìë£Œì‹¤ */
  .docs { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
  .doc { display:flex; gap:12px; padding:14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .doc .ico { font-size:26px; }
  .doc .title { font-weight:800; }
  .doc .desc { font-size:12px; color:#6b7280; }
  .doc .actions a { display:inline-block; margin-right:8px; text-decoration:none; border:1px solid #e5e7eb; padding:6px 10px; border-radius:10px; font-size:12px; font-weight:700; }

  /* í† ìŠ¤íŠ¸(3ì¤„ ì•Œë¦¼) */
  #toastBox { position: fixed; right: 24px; bottom: 24px; z-index: 50; display:flex; flex-direction:column; gap:10px; }
  .toast { width: 340px; max-width: calc(100vw - 40px); padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; background:#111; color:#fff; box-shadow: var(--shadow); opacity:.0; transform: translateY(8px); transition: all .22s ease; }
  .toast.show { opacity:1; transform: translateY(0); }
  .toast .title { font-weight:800; margin-bottom:4px; }
  .toast .line { font-size:12px; color:#d1d5db; }

  /* í•˜ë‹¨ ì¹´ë“œ ë§í¬ */
  .linkcard { display:block; text-decoration:none; color:inherit; transition:box-shadow .15s ease, transform .06s ease; }
  .linkcard:hover { box-shadow: 0 10px 24px rgba(0,0,0,.08); transform: translateY(-1px); }
  .bigtitle { font-size:18px; font-weight:800; margin:0; }
  .subtitle { font-size:13px; color:#6b7280; margin-top:6px; }
</style>
</head>
<body>
  <header>
    <div class="wrap brandbar">
      <div class="brand-mark">
        <img src="assets/img/keco_logo.png" alt="K-eco ë¡œê³ " />
        <div class="brand-name">
          <div class="org">í•œêµ­í™˜ê²½ê³µë‹¨</div>
          <div class="app">K-eco í”Œë¡œìš° ì²´í¬</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- ìƒë‹¨: ì‚¬ìš©ì ìŠ¤ìœ„ì¹˜ + ì„œë²„ ë™ê¸°í™” + ë‚´ë³´ë‚´ê¸° -->
      <div class="topbar">
        <div class="row">
          <div class="left row">
            <label class="row" style="gap:6px;">
              <span class="muted">ì‚¬ìš©ì ID</span>
              <input id="userId" type="text" placeholder="ì˜ˆ: íšŒì‚¬ëª…_ë‹´ë‹¹ì ë˜ëŠ” ì‚¬ë²ˆ" style="min-width:260px">
            </label>
            <button id="switchUser">ì—´ê¸°/ì „í™˜</button>
            <span id="saveState" class="muted">ë¯¸ì„ íƒ</span>
            <div class="sep"></div>
            <button id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          </div>
          <div class="right row">
            <input id="apiUrl" type="url" placeholder="(ì„ íƒ) ì„œë²„ ë™ê¸°í™” ì£¼ì†Œ â€” Apps Script ì›¹ì•± URL" style="min-width:320px">
            <button id="pullBtn" title="ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°">ì„œë²„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button id="pushBtn" class="btn primary" title="ì„œë²„ë¡œ ì˜¬ë¦¬ê¸°">ì„œë²„ ì €ì¥</button>
          </div>
        </div>
      </div>

      <!-- D-day í•œëˆˆì— -->
      <div class="card" style="margin:0;">
        <div class="row" id="ddayRow" style="gap:12px;"></div>
      </div>

      <!-- ì…ë ¥/ì¶”ê°€ íˆ´ë°” -->
      <div class="toolbar">
        <div class="row">
          <input id="titleInput" type="text" placeholder="ì œëª© (ì˜ˆ: 2025-08-12 Aê³µì¥ í˜¼í•©íê¸°ë¬¼)" style="min-width:340px">
          <select id="roleInput" title="ì—­í•  ì„ íƒ">
            <option value="carrier">ìš´ë°˜ì—…ì²´</option>
            <option value="processor">ì²˜ë¦¬ì—…ì²´</option>
            <option value="both" selected>ìš´ë°˜+ì²˜ë¦¬</option>
          </select>
          <button id="addBtn" class="btn primary">ìƒˆ ê±´ ì¶”ê°€</button>
          <span class="muted">â€» ì œëª© ì…ë ¥ í›„ <b>Enter</b>ë¡œë„ ì¶”ê°€ë¨</span>
        </div>
      </div>

      <!-- ë¦¬ìŠ¤íŠ¸ -->
      <div class="card">
        <table id="listTable">
          <thead>
            <tr>
              <th style="width:22%;">ì œëª©</th>
              <th>ì—­í• </th>
              <th>ë°°ì¶œì¼</th>
              <th>ì¸ìˆ˜ì™„ë£Œ<div class="muted">(ì²´í¬ ì‹œ ì¸ìˆ˜ì¼ ì €ì¥)</div></th>
              <th><span class="tip" tabindex="0" data-tip="ì°¸ê³ : íê¸°ë¬¼ê´€ë¦¬ë²• ì‹œí–‰ê·œì¹™ ì œ31ì¡° (ìµœì‹  ë²•ë ¹ í™•ì¸ ê¶Œì¥)">íê¸°ë¬¼ì²˜ë¦¬ê¸°í•œ â“˜</span><div class="note">ì²˜ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥</div></th>
              <th>ì²˜ë¦¬ì™„ë£Œ</th>
              <th><span class="tip" tabindex="0" data-tip="íê¸°ë¬¼ì²˜ë¶„ë¶€ë‹´ê¸ˆì€ ì†Œê°Â·ë§¤ë¦½ ë“± ìµœì¢… ì²˜ë¶„ëŸ‰ì— ë¶€ê³¼ë˜ëŠ” ë¶€ë‹´ê¸ˆì…ë‹ˆë‹¤. (ëª¨ë“  íê¸°ë¬¼ì´ ëŒ€ìƒì€ ì•„ë‹˜)&#10;â€» ê±´ì„¤ê³µì‚¬ ë“± ëŒ€ìƒì˜ ê²½ìš° ë³´í†µ 'ì¤€ê³µì¼ í›„ 30ì¼ ì´ë‚´' ì‹ ê³  í•„ìš”(ê¸°ê´€ ì§€ì¹¨/ë²•ë ¹ í™•ì¸ ìš”ë§).">ì²˜ë¶„ë¶€ë‹´ê¸ˆ í•´ë‹¹ì—¬ë¶€ â“˜</span><div class="note">ë¯¸í™•ì¸/í•´ë‹¹/ë¹„í•´ë‹¹</div></th>
              <th>íê¸°ë¬¼ì²˜ë¶„ë¶€ë‹´ê¸ˆ</th>
              <th>ìƒíƒœ</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>

      <!-- ìë£Œì‹¤ -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <h3 style="margin:0 0 8px 0;">ìë£Œì‹¤</h3>
          <div class="right row">
            <button id="diagBtn" title="assets/pdf ë‚´ë¶€ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ë¥¼ ì ê²€í•©ë‹ˆë‹¤.">ìë£Œ íŒŒì¼ ì§„ë‹¨</button>
            <div id="diagArea" class="row"></div>
          </div>
        </div>
        <div class="docs">
          <div class="doc">
            <div class="ico">ğŸ“˜</div>
            <div style="flex:1;">
              <div class="title">ì˜¬ë°”ë¡œì‹œìŠ¤í…œ ë§¤ë‰´ì–¼</div>
              <div class="desc">íšŒì›ê°€ì… â†’ ì¸ê³„ì„œì‘ì„± â†’ ëŒ€ì¥ê´€ë¦¬ â†’ ì‹¤ì ë³´ê³ </div>
              <div class="actions">
                <a href="assets/pdf/allbaro_manual_2025.pdf" target="_blank" rel="noopener">ë³´ê¸°</a>
                <a href="assets/pdf/allbaro_manual_2025.pdf" download>ë‹¤ìš´ë¡œë“œ</a>
              </div>
            </div>
          </div>
          <div class="doc">
            <div class="ico">ğŸ“™</div>
            <div style="flex:1;">
              <div class="title">íê¸°ë¬¼ì²˜ë¶„ë¶€ë‹´ê¸ˆ ë§¤ë‰´ì–¼</div>
              <div class="desc">ë¶€ë‹´ê¸ˆ ì‚°ì • Â· ê°ë©´ Â· ì‹ ê³ /ë‚©ë¶€ Â· ì˜¨ë¼ì¸ ì‹ ê³  ì ˆì°¨</div>
              <div class="actions">
                <a href="assets/pdf/levy_booklet_2025.pdf" target="_blank" rel="noopener">ë³´ê¸°</a>
                <a href="assets/pdf/levy_booklet_2025.pdf" download>ë‹¤ìš´ë¡œë“œ</a>
              </div>
            </div>
          </div>
        </div>
        <div class="muted" style="font-size:12px;margin-top:8px;">â€» íŒŒì¼ëª…ì´ ì˜ë¬¸/ìˆ«ìë§Œì´ë¼ ê²½ë¡œ ë¬¸ì œë¥¼ ìµœì†Œí™”í–ˆìŠµë‹ˆë‹¤.</div>
      </div>

      <!-- ì•ˆë‚´: íê¸°ë¬¼ì²˜ë¶„ë¶€ë‹´ê¸ˆ ì‚¬ì „ê³„ì‚° Â· ì¬í™œìš© ì•ˆë‚´ (í´ë¦­ ì¹´ë“œ) -->
      <a class="linkcard" href="./levy_calc_v5_editable_defaults.html" target="_blank" rel="noopener">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
            <h3 class="bigtitle">íê¸°ë¬¼ì²˜ë¶„ë¶€ë‹´ê¸ˆ ì‚¬ì „ê³„ì‚° Â· ì¬í™œìš© ì•ˆë‚´</h3>
            <span class="pill">ì—´ê¸°</span>
          </div>
          <div class="subtitle">ì¬í™œìš© ì „í™˜/ìœ í†µì§€ì›/ì²˜ë¦¬ì—…ì²´ ì°¾ê¸° ì•ˆë‚´ í¬í•¨</div>
        </div>
      </a>

      <!-- ì—°ë½ì²˜ -->
      <div class="footer">
        <div class="box">ì˜¬ë°”ë¡œì‹œìŠ¤í…œ ë¬¸ì˜: <b id="telAllbaro">062-949-0754</b></div>
        <div class="box">íê¸°ë¬¼ì²˜ë¶„ë¶€ë‹´ê¸ˆ ë¬¸ì˜: <b id="telLevy">062-949-0305</b></div>
      </div>

    </div>
  </main>

  <div id="toastBox" aria-live="polite" aria-atomic="true"></div>

<script>
function storageAvailable() {
  try { var x='__t__'+Math.random(); localStorage.setItem(x,'1'); localStorage.removeItem(x); return true; } catch(e){ return false; }
}
var STORAGE_OK = storageAvailable();
var BASE_KEY = 'mini_route_checker_items_v71';
var CUR_USER = '';
var STATE = [];

function keyFor(user){ return BASE_KEY + '::' + (user||'default'); }
function load(user){
  if(!STORAGE_OK){ return []; }
  try { return JSON.parse(localStorage.getItem(keyFor(user)) || '[]'); } catch(e){ return []; }
}
function save(){
  var el = document.getElementById('saveState');
  if(!STORAGE_OK){ el.textContent = 'ì €ì¥ ë¶ˆê°€(ì„ì‹œ)'; return; }
  try { localStorage.setItem(keyFor(CUR_USER), JSON.stringify(STATE)); el.textContent = 'ìë™ì €ì¥ë¨'; }
  catch(e){ el.textContent = 'ì €ì¥ ì˜¤ë¥˜'; }
}
async function switchUser(){
  var id = document.getElementById('userId').value.trim();
  if(!id){ alert('ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); document.getElementById('userId').focus(); return; }
  CUR_USER = id;
  STATE = load(CUR_USER);
  if(STATE.length>0){
    document.getElementById('saveState').textContent = 'ë¡œì»¬ ë¶ˆëŸ¬ì˜´';
    render();
    return;
  }
  var api = document.getElementById('apiUrl').value.trim();
  if(api){
    try{
      var res = await fetch(api + '?user=' + encodeURIComponent(CUR_USER), { method:'GET' });
      if(res.ok){
        var obj = await res.json();
        if(obj && Array.isArray(obj.data)){
          STATE = obj.data; save(); document.getElementById('saveState').textContent = 'ì„œë²„ ë¶ˆëŸ¬ì˜´';
          render(); return;
        }
      }
    }catch(e){ /* ignore */ }
  }
  STATE = []; document.getElementById('saveState').textContent = 'ì‹ ê·œ ì‚¬ìš©ì(ë¹ˆ ëª©ë¡)';
  render();
}

// Dates helpers
function todayStr(){ var d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(s){ if(!s) return null; var d=new Date(s); d.setHours(0,0,0,0); return d; }
function addDays(s,n){ var d=toDate(s); if(!d) return null; d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function ddayLabel(target){ 
  if(!target) return '-';
  var t = toDate(target), today = toDate(todayStr());
  var delta = Math.floor((t - today)/86400000);
  if (delta > 0) return 'D-' + delta;
  if (delta === 0) return 'D-DAY';
  return 'D+' + Math.abs(delta);
}
function escapeHtml(s){ 
  return String(s||'').replace(/[&<>\"']/g, function(ch){ 
    return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]; 
  }); 
}

function showToast(lines, title){
  var box = document.getElementById('toastBox');
  var item = document.createElement('div'); item.className='toast';
  var html='';
  if(title){ html += '<div class="title">'+escapeHtml(title)+'</div>'; }
  (lines||[]).forEach(function(t){ html += '<div class="line">'+escapeHtml(t)+'</div>'; });
  item.innerHTML = html;
  box.appendChild(item);
  requestAnimationFrame(()=>{ item.classList.add('show'); });
  setTimeout(()=>{
    item.classList.remove('show');
    item.addEventListener('transitionend', ()=> item.remove(), {once:true});
  }, 4200);
}

function renderDday(){
  var row = document.getElementById('ddayRow');
  if(!CUR_USER){
    row.innerHTML = '<span class="chip"><span>ì‚¬ìš©ì ì„ íƒ í•„ìš”</span></span>';
    return;
  }
  var receiptCandidates = STATE.filter(x=> !x.received_done && x.emit_date).map(x=> ({ id:x.id, title:x.title, due: addDays(x.emit_date, 2) })).filter(o=>!!o.due);
  receiptCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var rec = receiptCandidates.length ? receiptCandidates[0] : null;

  var procCandidates = STATE.filter(x=> !x.processed_done && x.due_date).map(x=> ({ id:x.id, title:x.title, due:x.due_date }));
  procCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var pro = procCandidates.length ? procCandidates[0] : null;

  var levyCandidates = STATE.filter(x=> x.levy_applicable==='í•´ë‹¹' && !x.levy_done && x.completion_date)
      .map(x=> ({ id:x.id, title:x.title, due: addDays(x.completion_date, 30) }))
      .filter(o=>!!o.due);
  levyCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var lev = levyCandidates.length ? levyCandidates[0] : null;

  function chip(label, obj){
    if(!obj) return '<span class="chip"><span>'+label+'</span><span class="dd">-</span></span>';
    var dd = ddayLabel(obj.due);
    var warn = (toDate(obj.due) - toDate(todayStr())) < 0;
    return '<span class="chip '+(warn?'warn':'ok')+'"><span>'+label+'</span><span class="dd">'+dd+'</span><span class="muted">('+escapeHtml(obj.title)+')</span></span>';
  }

  row.innerHTML = chip('ì¸ìˆ˜ D-day', rec) + chip('ì²˜ë¦¬ D-day', pro) + chip('ë¶€ë‹´ê¸ˆ ì‹ ê³  D-day', lev);
}

function render(){
  renderDday();
  var body = document.getElementById('listBody');
  body.innerHTML = '';

  STATE.forEach(function(x){
    var tr = document.createElement('tr');

    var tdTitle = document.createElement('td');
    tdTitle.innerHTML = '<div>'+escapeHtml(x.title)+'</div><div class="muted">'+escapeHtml(x.id)+'</div>';
    tr.appendChild(tdTitle);

    var tdRole = document.createElement('td');
    var roleSel = document.createElement('select');
    [['carrier','ìš´ë°˜ì—…ì²´'],['processor','ì²˜ë¦¬ì—…ì²´'],['both','ìš´ë°˜+ì²˜ë¦¬']].forEach(function(pair){
      var op = document.createElement('option'); op.value = pair[0]; op.textContent = pair[1]; roleSel.appendChild(op);
    });
    roleSel.value = x.role || 'carrier';
    roleSel.onchange = function(e){ x.role = e.target.value; save(); render(); };
    tdRole.appendChild(roleSel);
    tr.appendChild(tdRole);

    var tdEmit = document.createElement('td');
    var emit = document.createElement('input');
    emit.type='date'; emit.value = x.emit_date || '';
    emit.onchange = function(e){ 
      x.emit_date = e.target.value; save(); render(); 
      if(x.emit_date){
        var due = addDays(x.emit_date, 2);
        var tel1 = document.getElementById('telAllbaro').textContent;
        var tel2 = document.getElementById('telLevy').textContent;
        showToast([
          'ì¸ìˆ˜ê¸°í•œ: '+(due||'-'),
          'ê´€ë ¨ ë¬¸ì˜: ì˜¬ë°”ë¡œ '+tel1+', ë¶€ë‹´ê¸ˆ '+tel2,
          'ê±´: '+x.title
        ], 'ë°°ì¶œ ë“±ë¡');
      }
    };
    tdEmit.appendChild(emit);
    tr.appendChild(tdEmit);

    var tdRecv = document.createElement('td');
    var recvWrap = document.createElement('label'); recvWrap.style.display='inline-flex'; recvWrap.style.alignItems='center'; recvWrap.style.gap='6px';
    var recv = document.createElement('input'); recv.type='checkbox'; recv.checked = !!x.received_done;
    recv.onchange = function(e){
      var before = !!x.received_done;
      x.received_done = !!e.target.checked;
      if(x.received_done){ x.received_at = x.received_at || todayStr(); }
      else { x.received_at = null; }
      save(); render();
      if(!before && x.received_done){
        showToast([
          'ì¸ìˆ˜ì¼ í™•ì •: '+(x.received_at||todayStr()),
          'ì²˜ë¦¬ê¸°í•œ: '+(x.due_date||'-'),
          'ê±´: '+x.title
        ], 'ì¸ìˆ˜ ì™„ë£Œ');
      }
    };
    var recvSpan = document.createElement('span'); recvSpan.textContent = 'ì¸ìˆ˜ì™„ë£Œ';
    recvWrap.appendChild(recv); recvWrap.appendChild(recvSpan);
    tdRecv.appendChild(recvWrap);

    if(x.received_done){
      var recvDate = document.createElement('input'); recvDate.type='date'; recvDate.value = x.received_at || todayStr();
      recvDate.onchange = function(e){ x.received_at = e.target.value; save(); render(); };
      recvDate.style.marginLeft='8px'; tdRecv.appendChild(recvDate);
      if(x.emit_date){
        var due = addDays(x.emit_date, 2);
        if(due){
          var late = (toDate(x.received_at||todayStr()) - toDate(due)) > 0;
          var note = document.createElement('div'); note.className='note';
          note.textContent = 'ì¸ìˆ˜ê¸°í•œ: '+due + (late ? ' (ì§€ì—°)' : '');
          tdRecv.appendChild(note);
        }
      }
    }
    tr.appendChild(tdRecv);

    var tdDue = document.createElement('td');
    var dueInput = document.createElement('input');
    dueInput.type='date'; dueInput.value = x.due_date || '';
    dueInput.onchange = function(e){ x.due_date = e.target.value; save(); render(); };
    var canEditDue = (x.role==='processor' || x.role==='both');
    if(!canEditDue){ dueInput.disabled = true; dueInput.title='ì²˜ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥'; }
    tdDue.appendChild(dueInput);
    if(!canEditDue){
      var helper = document.createElement('div'); helper.className='note';
      helper.textContent = 'ì—­í• ì„ ì²˜ë¦¬ì—…ì²´/ìš´ë°˜+ì²˜ë¦¬ë¡œ ë°”ê¾¸ë©´ ìˆ˜ì • ê°€ëŠ¥';
      tdDue.appendChild(helper);
    }
    tr.appendChild(tdDue);

    var tdProc = document.createElement('td');
    var procWrap = document.createElement('label'); procWrap.style.display='inline-flex'; procWrap.style.alignItems='center'; procWrap.style.gap='6px';
    var proc = document.createElement('input'); proc.type='checkbox'; proc.checked = !!x.processed_done;
    proc.onchange = function(e){ 
      var before = !!x.processed_done;
      x.processed_done = !!e.target.checked; 
      if(x.processed_done){ x.processed_at = x.processed_at || todayStr(); }
      else { x.processed_at = null; }
      save(); render(); 
      if(!before && x.processed_done){
        var line2 = (x.levy_applicable==='í•´ë‹¹' && x.completion_date) ? ('ì¤€ê³µ í›„ 30ì¼: '+addDays(x.completion_date,30)) : 'ì¤€ê³µì¼ ì…ë ¥ ì‹œ ì‹ ê³ ê¸°í•œ ì•ˆë‚´';
        showToast([
          'ì²˜ë¶„ë¶€ë‹´ê¸ˆ: '+(x.levy_applicable||'ë¯¸í™•ì¸'),
          line2,
          'ê±´: '+x.title
        ], 'ì²˜ë¦¬ ì™„ë£Œ');
      }
    };
    var procSpan = document.createElement('span'); procSpan.textContent = 'ì²˜ë¦¬ì™„ë£Œ';
    procWrap.appendChild(proc); procWrap.appendChild(procSpan);
    tdProc.appendChild(procWrap);
    tr.appendChild(tdProc);

    var tdApplicable = document.createElement('td');
    var sel = document.createElement('select');
    ['ë¯¸í™•ì¸','í•´ë‹¹','ë¹„í•´ë‹¹'].forEach(function(v){ var op=document.createElement('option'); op.value=v; op.textContent=v; sel.appendChild(op); });
    sel.value = x.levy_applicable || 'ë¯¸í™•ì¸';
    sel.onchange = function(e){ 
      x.levy_applicable = e.target.value; if(x.levy_applicable!=='í•´ë‹¹'){ x.levy_done=false; }
      save(); render(); 
    };
    tdApplicable.appendChild(sel);

    if(x.levy_applicable==='í•´ë‹¹'){
      var block = document.createElement('div'); block.style.marginTop='6px';
      var lbl = document.createElement('label'); lbl.className='note'; lbl.textContent='ì¤€ê³µì¼';
      var comp = document.createElement('input'); comp.type='date'; comp.style.marginLeft='8px'; comp.value = x.completion_date || '';
      comp.onchange = function(e){ x.completion_date = e.target.value; save(); render(); };
      block.appendChild(lbl); block.appendChild(comp);
      if(x.completion_date){
        var levyDue = addDays(x.completion_date, 30);
        var n = document.createElement('div'); n.className='note'; n.textContent='ì‹ ê³ ê¸°í•œ(ì¤€ê³µ+30): '+ (levyDue||'-');
        block.appendChild(n);
      }
      tdApplicable.appendChild(block);
    }
    tr.appendChild(tdApplicable);

    var tdLevy = document.createElement('td');
    var wrap = document.createElement('div'); var disabled = x.levy_applicable!=='í•´ë‹¹'; wrap.style.opacity = disabled ? .45 : 1;
    var levy = document.createElement('label'); levy.style.display='inline-flex'; levy.style.alignItems='center'; levy.style.gap='6px';
    var levyBox = document.createElement('input'); levyBox.type='checkbox'; levyBox.checked = !!x.levy_done; levyBox.disabled = disabled;
    levyBox.onchange = function(e){ x.levy_done = !!e.target.checked; x.levy_at = x.levy_done ? (x.levy_at||todayStr()) : null; save(); render(); };
    var levySpan = document.createElement('span'); levySpan.textContent = 'ì‹ ê³ ì™„ë£Œ';
    levy.appendChild(levyBox); levy.appendChild(levySpan); wrap.appendChild(levy);
    tdLevy.appendChild(wrap);
    tr.appendChild(tdLevy);

    var tdStatus = document.createElement('td');
    tdStatus.innerHTML = statusText(x);
    tr.appendChild(tdStatus);

    var tdDel = document.createElement('td');
    var del = document.createElement('button'); del.textContent = 'ì‚­ì œ'; del.onclick = function(){ STATE = STATE.filter(i=> i.id!==x.id); save(); render(); };
    tdDel.appendChild(del);
    tr.appendChild(tdDel);

    body.appendChild(tr);
  });
}

function statusText(x){
  var recDue = x.emit_date ? addDays(x.emit_date, 2) : null;
  var recDD = (!x.received_done && recDue) ? ddayLabel(recDue) : null;
  var proDD = (!x.processed_done && x.due_date) ? ddayLabel(x.due_date) : null;
  var levyDue = (x.levy_applicable==='í•´ë‹¹' && !x.levy_done && x.completion_date) ? addDays(x.completion_date,30) : null;
  var levDD = levyDue ? ddayLabel(levyDue) : null;

  var parts = [];
  if(recDD){ parts.push('<span class="pill">ì¸ìˆ˜ '+recDD+'</span>'); }
  if(proDD){ parts.push('<span class="pill">ì²˜ë¦¬ '+proDD+'</span>'); }
  if(levDD){ parts.push('<span class="pill">ë¶€ë‹´ê¸ˆ '+levDD+'</span>'); }
  if(!parts.length) parts.push('<span class="muted">-</span>');
  return parts.join(' ');
}

async function checkFile(url){
  try{
    let res = await fetch(url, { method:'HEAD' });
    if(!res.ok){ res = await fetch(url, { method:'GET' }); }
    return res.ok;
  }catch(e){ return false; }
}
async function runDiag(){
  const area = document.getElementById('diagArea');
  area.innerHTML = '<span class="muted">ì ê²€ ì¤‘...</span>';
  const files = [
    ['ì˜¬ë°”ë¡œ', 'assets/pdf/allbaro_manual_2025.pdf'],
    ['ë¶€ë‹´ê¸ˆ', 'assets/pdf/levy_booklet_2025.pdf'],
  ];
  const results = await Promise.all(files.map(f => checkFile(f[1])));
  area.innerHTML = files.map((f,i)=> '<span class="chip '+(results[i]?'ok':'err')+'"><b>'+f[0]+'</b> '+(results[i]?'ìˆìŒ âœ…':'ì—†ìŒ âŒ')+'</span>').join(' ');
}

function exportJson(){
  if(!CUR_USER){ alert('ë¨¼ì € ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ê³  ì—´ì–´ì£¼ì„¸ìš”.'); return; }
  var blob = new Blob([JSON.stringify({ user: CUR_USER, data: STATE }, null, 2)], {type:'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'route_checker_'+CUR_USER+'_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
async function pullFromServer(){
  if(!CUR_USER){ alert('ë¨¼ì € ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ê³  ì—´ì–´ì£¼ì„¸ìš”.'); return; }
  var url = document.getElementById('apiUrl').value.trim();
  if(!url){ alert('ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try{
    var res = await fetch(url + '?user=' + encodeURIComponent(CUR_USER), { method:'GET' });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    var obj = await res.json();
    if(obj && Array.isArray(obj.data)){ STATE = obj.data; save(); render(); alert('ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.'); }
    else { alert('ì„œë²„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'); }
  }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + e.message); }
}
async function pushToServer(){
  if(!CUR_USER){ alert('ë¨¼ì € ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ê³  ì—´ì–´ì£¼ì„¸ìš”.'); return; }
  var url = document.getElementById('apiUrl').value.trim();
  if(!url){ alert('ì„œë²„ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  try{
    var res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: CUR_USER, data: STATE }) });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    alert('ì„œë²„ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  }catch(e){ alert('ì €ì¥ ì‹¤íŒ¨: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('switchUser').addEventListener('click', switchUser);
  document.getElementById('exportBtn').addEventListener('click', exportJson);
  document.getElementById('pullBtn').addEventListener('click', pullFromServer);
  document.getElementById('pushBtn').addEventListener('click', pushToServer);
  document.getElementById('diagBtn').addEventListener('click', runDiag);

  document.getElementById('userId').addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); switchUser(); } });

  var addBtn = document.getElementById('addBtn');
  var title = document.getElementById('titleInput');
  var role = document.getElementById('roleInput');

  function ensureUser(){
    if(CUR_USER) return true;
    var input = document.getElementById('userId');
    var id = (input.value.trim() || 'default');
    CUR_USER = id;
    input.value = id;
    STATE = load(CUR_USER);
    document.getElementById('saveState').textContent = STATE.length ? 'ë¡œì»¬ ë¶ˆëŸ¬ì˜´(ìë™)' : 'ì‹ ê·œ ì‚¬ìš©ì(ìë™)';
    return true;
  }

  function add(){
    ensureUser(); // ìë™ ì‚¬ìš©ì ì§€ì •
    var v = title.value.trim();
    if(!v){ alert('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); title.focus(); return; }
    STATE.unshift({
      id: (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-'+Date.now(),
      title: v, role: role.value,
      emit_date: '', received_done:false, received_at:null,
      due_date: '', processed_done:false, processed_at:null,
      levy_applicable:'ë¯¸í™•ì¸', completion_date:'', levy_done:false, levy_at:null
    });
    save(); title.value=''; render();
  }

  addBtn.addEventListener('click', add);
  title.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); add(); } });

  render();
});
</script>
</body>
</html>
