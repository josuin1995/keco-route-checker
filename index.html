<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K-eco 플로우 체크</title>
<style>
  :root { --gap: 10px; --radius: 12px; --muted:#6b7280; --shadow: 0 10px 20px rgba(0,0,0,.08); }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', sans-serif; margin: 0; padding: 0; background:#f5f7fb; color:#111; }
  header { position: sticky; top:0; z-index: 20; background:#fff; box-shadow: var(--shadow); }
  .wrap { max-width: 1400px; margin: 0 auto; padding: 16px 24px; } /* 넓게 */
  .brandbar { display:flex; align-items:center; gap:12px; }
  .brand-mark { display:flex; align-items:center; gap:10px; padding:8px 10px; }
  .brand-mark img { height:44px; object-fit: contain; }
  .brand-name { display:flex; flex-direction:column; line-height:1.2; }
  .brand-name .org { font-size:13px; color:#374151; }
  .brand-name .app { font-size:22px; font-weight:800; }
  .toolbar, .topbar, .card { border:1px solid #e5e7eb; border-radius: var(--radius); background:#fff; }
  main .wrap { display: grid; gap: 16px; }
  .toolbar, .topbar { padding: 12px; }
  .card { padding: 12px; }
  .row { display:flex; gap:var(--gap); align-items:center; flex-wrap:wrap; }
  select, input[type="text"], input[type="date"], input[type="url"], input[type="number"] { padding: 8px 10px; border:1px solid #d1d5db; border-radius:8px; background:#fff; }
  button { padding: 8px 12px; border:1px solid #cfcfcf; border-radius:8px; background:#f6f6f6; cursor:pointer; }
  button.primary { border-color:#111; background:#111; color:#fff; }
  table { width:100%; border-collapse: collapse; background:#fff; }
  th, td { border-bottom:1px solid #eee; padding: 10px; text-align:left; vertical-align: middle; }
  th { font-weight:600; background:#f4f6f8; }
  .pill { display:inline-block; padding: 4px 10px; border-radius: 999px; font-size: 12px; border:1px solid #e5e7eb; background:#fafafa; }
  .muted { color: var(--muted); font-size: 12px; }
  .note { font-size:12px; color:#6b7280; }
  .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #e5e7eb; background:#fff; font-size:12px; }
  .chip .dd { font-weight:700; }
  .chip.warn { background:#fff5f5; border-color:#f5c2c2; }
  .chip.ok { background:#f0fff4; border-color:#8fd19e; }
  .chip.err { background:#fff5f5; border-color:#f5c2c2; }
  .footer { margin-top:16px; font-size:12px; color:#374151; display:flex; gap:24px; flex-wrap:wrap; }
  .footer .box { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; }
  .left { flex:1; }
  .right { display:flex; gap:8px; }
  .sep { width:1px; height:20px; background:#e5e7eb; }
  .tip { position: relative; display:inline-block; cursor: help; }
  .tip::after {
    content: attr(data-tip);
    position: absolute;
    left: 0;
    bottom: 120%;
    min-width: 240px;
    max-width: 360px;
    padding: 8px 10px;
    border-radius: 8px;
    background: #111;
    color:#fff;
    font-size: 12px;
    line-height: 1.4;
    white-space: pre-wrap;
    box-shadow: 0 6px 20px rgba(0,0,0,.15);
    opacity: 0;
    transform: translateY(6px);
    pointer-events: none;
    transition: opacity .15s ease, transform .15s ease;
    z-index: 10;
  }
  .tip:focus::after, .tip:hover::after { opacity: 1; transform: translateY(0); }
  /* 자료실 */
  .docs { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); }
  .doc { display:flex; gap:12px; padding:14px; border:1px solid #e5e7eb; border-radius:12px; background:#fff; }
  .doc .ico { font-size:26px; }
  .doc .title { font-weight:800; }
  .doc .desc { font-size:12px; color:#6b7280; }
  .doc .actions a { display:inline-block; margin-right:8px; text-decoration:none; border:1px solid #e5e7eb; padding:6px 10px; border-radius:10px; font-size:12px; font-weight:700; }

  /* 토스트(3줄 알림) */
  #toastBox { position: fixed; right: 24px; bottom: 24px; z-index: 50; display:flex; flex-direction:column; gap:10px; }
  .toast { width: 340px; max-width: calc(100vw - 40px); padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; background:#111; color:#fff; box-shadow: var(--shadow); opacity:.0; transform: translateY(8px); transition: all .22s ease; }
  .toast.show { opacity:1; transform: translateY(0); }
  .toast .title { font-weight:800; margin-bottom:4px; }
  .toast .line { font-size:12px; color:#d1d5db; }

  /* 하단 카드 링크 */
  .linkcard { display:block; text-decoration:none; color:inherit; transition:box-shadow .15s ease, transform .06s ease; }
  .linkcard:hover { box-shadow: 0 10px 24px rgba(0,0,0,.08); transform: translateY(-1px); }
  .bigtitle { font-size:18px; font-weight:800; margin:0; }
  .subtitle { font-size:13px; color:#6b7280; margin-top:6px; }
</style>
</head>
<body>
  <header>
    <div class="wrap brandbar">
      <div class="brand-mark">
        <img src="assets/img/keco_logo.png" alt="K-eco 로고" />
        <div class="brand-name">
          <div class="org">한국환경공단</div>
          <div class="app">K-eco 플로우 체크</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- 상단: 사용자 스위치 + 서버 동기화 + 내보내기 -->
      <div class="topbar">
        <div class="row">
          <div class="left row">
            <label class="row" style="gap:6px;">
              <span class="muted">사용자 ID</span>
              <input id="userId" type="text" placeholder="예: 회사명_담당자 또는 사번" style="min-width:260px">
            </label>
            <button id="switchUser">열기/전환</button>
            <span id="saveState" class="muted">미선택</span>
            <div class="sep"></div>
            <button id="exportBtn">내보내기(JSON)</button>
          </div>
          <div class="right row">
            <input id="apiUrl" type="url" placeholder="(선택) 서버 동기화 주소 — Apps Script 웹앱 URL" style="min-width:320px">
            <button id="pullBtn" title="서버에서 불러오기">서버 불러오기</button>
            <button id="pushBtn" class="btn primary" title="서버로 올리기">서버 저장</button>
          </div>
        </div>
      </div>

      <!-- D-day 한눈에 -->
      <div class="card" style="margin:0;">
        <div class="row" id="ddayRow" style="gap:12px;"></div>
      </div>

      <!-- 입력/추가 툴바 -->
      <div class="toolbar">
        <div class="row">
          <input id="titleInput" type="text" placeholder="제목 (예: 2025-08-12 A공장 혼합폐기물)" style="min-width:340px">
          <select id="roleInput" title="역할 선택">
            <option value="carrier">운반업체</option>
            <option value="processor">처리업체</option>
            <option value="both" selected>운반+처리</option>
          </select>
          <button id="addBtn" class="btn primary">새 건 추가</button>
          <span class="muted">※ 제목 입력 후 <b>Enter</b>로도 추가됨</span>
        </div>
      </div>

      <!-- 리스트 -->
      <div class="card">
        <table id="listTable">
          <thead>
            <tr>
              <th style="width:22%;">제목</th>
              <th>역할</th>
              <th>배출일</th>
              <th>인수완료<div class="muted">(체크 시 인수일 저장)</div></th>
              <th><span class="tip" tabindex="0" data-tip="참고: 폐기물관리법 시행규칙 제31조 (최신 법령 확인 권장)">폐기물처리기한 ⓘ</span><div class="note">처리자만 수정 가능</div></th>
              <th>처리완료</th>
              <th><span class="tip" tabindex="0" data-tip="폐기물처분부담금은 소각·매립 등 최종 처분량에 부과되는 부담금입니다. (모든 폐기물이 대상은 아님)&#10;※ 건설공사 등 대상의 경우 보통 '준공일 후 30일 이내' 신고 필요(기관 지침/법령 확인 요망).">처분부담금 해당여부 ⓘ</span><div class="note">미확인/해당/비해당</div></th>
              <th>폐기물처분부담금</th>
              <th>상태</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="listBody"></tbody>
        </table>
      </div>

      <!-- 자료실 -->
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
          <h3 style="margin:0 0 8px 0;">자료실</h3>
          <div class="right row">
            <button id="diagBtn" title="assets/pdf 내부 파일 존재 여부를 점검합니다.">자료 파일 진단</button>
            <div id="diagArea" class="row"></div>
          </div>
        </div>
        <div class="docs">
          <div class="doc">
            <div class="ico">📘</div>
            <div style="flex:1;">
              <div class="title">올바로시스템 매뉴얼</div>
              <div class="desc">회원가입 → 인계서작성 → 대장관리 → 실적보고</div>
              <div class="actions">
                <a href="assets/pdf/allbaro_manual_2025.pdf" target="_blank" rel="noopener">보기</a>
                <a href="assets/pdf/allbaro_manual_2025.pdf" download>다운로드</a>
              </div>
            </div>
          </div>
          <div class="doc">
            <div class="ico">📙</div>
            <div style="flex:1;">
              <div class="title">폐기물처분부담금 매뉴얼</div>
              <div class="desc">부담금 산정 · 감면 · 신고/납부 · 온라인 신고 절차</div>
              <div class="actions">
                <a href="assets/pdf/levy_booklet_2025.pdf" target="_blank" rel="noopener">보기</a>
                <a href="assets/pdf/levy_booklet_2025.pdf" download>다운로드</a>
              </div>
            </div>
          </div>
        </div>
        <div class="muted" style="font-size:12px;margin-top:8px;">※ 파일명이 영문/숫자만이라 경로 문제를 최소화했습니다.</div>
      </div>

      <!-- 안내: 폐기물처분부담금 사전계산 · 재활용 안내 (클릭 카드) -->
      <a class="linkcard" href="./levy_calc_v5_editable_defaults.html" target="_blank" rel="noopener">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
            <h3 class="bigtitle">폐기물처분부담금 사전계산 · 재활용 안내</h3>
            <span class="pill">열기</span>
          </div>
          <div class="subtitle">재활용 전환/유통지원/처리업체 찾기 안내 포함</div>
        </div>
      </a>

      <!-- 연락처 -->
      <div class="footer">
        <div class="box">올바로시스템 문의: <b id="telAllbaro">062-949-0754</b></div>
        <div class="box">폐기물처분부담금 문의: <b id="telLevy">062-949-0305</b></div>
      </div>

    </div>
  </main>

  <div id="toastBox" aria-live="polite" aria-atomic="true"></div>

<script>
function storageAvailable() {
  try { var x='__t__'+Math.random(); localStorage.setItem(x,'1'); localStorage.removeItem(x); return true; } catch(e){ return false; }
}
var STORAGE_OK = storageAvailable();
var BASE_KEY = 'mini_route_checker_items_v71';
var CUR_USER = '';
var STATE = [];

function keyFor(user){ return BASE_KEY + '::' + (user||'default'); }
function load(user){
  if(!STORAGE_OK){ return []; }
  try { return JSON.parse(localStorage.getItem(keyFor(user)) || '[]'); } catch(e){ return []; }
}
function save(){
  var el = document.getElementById('saveState');
  if(!STORAGE_OK){ el.textContent = '저장 불가(임시)'; return; }
  try { localStorage.setItem(keyFor(CUR_USER), JSON.stringify(STATE)); el.textContent = '자동저장됨'; }
  catch(e){ el.textContent = '저장 오류'; }
}
async function switchUser(){
  var id = document.getElementById('userId').value.trim();
  if(!id){ alert('사용자 ID를 입력하세요.'); document.getElementById('userId').focus(); return; }
  CUR_USER = id;
  STATE = load(CUR_USER);
  if(STATE.length>0){
    document.getElementById('saveState').textContent = '로컬 불러옴';
    render();
    return;
  }
  var api = document.getElementById('apiUrl').value.trim();
  if(api){
    try{
      var res = await fetch(api + '?user=' + encodeURIComponent(CUR_USER), { method:'GET' });
      if(res.ok){
        var obj = await res.json();
        if(obj && Array.isArray(obj.data)){
          STATE = obj.data; save(); document.getElementById('saveState').textContent = '서버 불러옴';
          render(); return;
        }
      }
    }catch(e){ /* ignore */ }
  }
  STATE = []; document.getElementById('saveState').textContent = '신규 사용자(빈 목록)';
  render();
}

// Dates helpers
function todayStr(){ var d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function toDate(s){ if(!s) return null; var d=new Date(s); d.setHours(0,0,0,0); return d; }
function addDays(s,n){ var d=toDate(s); if(!d) return null; d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); }
function ddayLabel(target){ 
  if(!target) return '-';
  var t = toDate(target), today = toDate(todayStr());
  var delta = Math.floor((t - today)/86400000);
  if (delta > 0) return 'D-' + delta;
  if (delta === 0) return 'D-DAY';
  return 'D+' + Math.abs(delta);
}
function escapeHtml(s){ 
  return String(s||'').replace(/[&<>\"']/g, function(ch){ 
    return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]; 
  }); 
}

function showToast(lines, title){
  var box = document.getElementById('toastBox');
  var item = document.createElement('div'); item.className='toast';
  var html='';
  if(title){ html += '<div class="title">'+escapeHtml(title)+'</div>'; }
  (lines||[]).forEach(function(t){ html += '<div class="line">'+escapeHtml(t)+'</div>'; });
  item.innerHTML = html;
  box.appendChild(item);
  requestAnimationFrame(()=>{ item.classList.add('show'); });
  setTimeout(()=>{
    item.classList.remove('show');
    item.addEventListener('transitionend', ()=> item.remove(), {once:true});
  }, 4200);
}

function renderDday(){
  var row = document.getElementById('ddayRow');
  if(!CUR_USER){
    row.innerHTML = '<span class="chip"><span>사용자 선택 필요</span></span>';
    return;
  }
  var receiptCandidates = STATE.filter(x=> !x.received_done && x.emit_date).map(x=> ({ id:x.id, title:x.title, due: addDays(x.emit_date, 2) })).filter(o=>!!o.due);
  receiptCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var rec = receiptCandidates.length ? receiptCandidates[0] : null;

  var procCandidates = STATE.filter(x=> !x.processed_done && x.due_date).map(x=> ({ id:x.id, title:x.title, due:x.due_date }));
  procCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var pro = procCandidates.length ? procCandidates[0] : null;

  var levyCandidates = STATE.filter(x=> x.levy_applicable==='해당' && !x.levy_done && x.completion_date)
      .map(x=> ({ id:x.id, title:x.title, due: addDays(x.completion_date, 30) }))
      .filter(o=>!!o.due);
  levyCandidates.sort((a,b)=> toDate(a.due)-toDate(b.due));
  var lev = levyCandidates.length ? levyCandidates[0] : null;

  function chip(label, obj){
    if(!obj) return '<span class="chip"><span>'+label+'</span><span class="dd">-</span></span>';
    var dd = ddayLabel(obj.due);
    var warn = (toDate(obj.due) - toDate(todayStr())) < 0;
    return '<span class="chip '+(warn?'warn':'ok')+'"><span>'+label+'</span><span class="dd">'+dd+'</span><span class="muted">('+escapeHtml(obj.title)+')</span></span>';
  }

  row.innerHTML = chip('인수 D-day', rec) + chip('처리 D-day', pro) + chip('부담금 신고 D-day', lev);
}

function render(){
  renderDday();
  var body = document.getElementById('listBody');
  body.innerHTML = '';

  STATE.forEach(function(x){
    var tr = document.createElement('tr');

    var tdTitle = document.createElement('td');
    tdTitle.innerHTML = '<div>'+escapeHtml(x.title)+'</div><div class="muted">'+escapeHtml(x.id)+'</div>';
    tr.appendChild(tdTitle);

    var tdRole = document.createElement('td');
    var roleSel = document.createElement('select');
    [['carrier','운반업체'],['processor','처리업체'],['both','운반+처리']].forEach(function(pair){
      var op = document.createElement('option'); op.value = pair[0]; op.textContent = pair[1]; roleSel.appendChild(op);
    });
    roleSel.value = x.role || 'carrier';
    roleSel.onchange = function(e){ x.role = e.target.value; save(); render(); };
    tdRole.appendChild(roleSel);
    tr.appendChild(tdRole);

    var tdEmit = document.createElement('td');
    var emit = document.createElement('input');
    emit.type='date'; emit.value = x.emit_date || '';
    emit.onchange = function(e){ 
      x.emit_date = e.target.value; save(); render(); 
      if(x.emit_date){
        var due = addDays(x.emit_date, 2);
        var tel1 = document.getElementById('telAllbaro').textContent;
        var tel2 = document.getElementById('telLevy').textContent;
        showToast([
          '인수기한: '+(due||'-'),
          '관련 문의: 올바로 '+tel1+', 부담금 '+tel2,
          '건: '+x.title
        ], '배출 등록');
      }
    };
    tdEmit.appendChild(emit);
    tr.appendChild(tdEmit);

    var tdRecv = document.createElement('td');
    var recvWrap = document.createElement('label'); recvWrap.style.display='inline-flex'; recvWrap.style.alignItems='center'; recvWrap.style.gap='6px';
    var recv = document.createElement('input'); recv.type='checkbox'; recv.checked = !!x.received_done;
    recv.onchange = function(e){
      var before = !!x.received_done;
      x.received_done = !!e.target.checked;
      if(x.received_done){ x.received_at = x.received_at || todayStr(); }
      else { x.received_at = null; }
      save(); render();
      if(!before && x.received_done){
        showToast([
          '인수일 확정: '+(x.received_at||todayStr()),
          '처리기한: '+(x.due_date||'-'),
          '건: '+x.title
        ], '인수 완료');
      }
    };
    var recvSpan = document.createElement('span'); recvSpan.textContent = '인수완료';
    recvWrap.appendChild(recv); recvWrap.appendChild(recvSpan);
    tdRecv.appendChild(recvWrap);

    if(x.received_done){
      var recvDate = document.createElement('input'); recvDate.type='date'; recvDate.value = x.received_at || todayStr();
      recvDate.onchange = function(e){ x.received_at = e.target.value; save(); render(); };
      recvDate.style.marginLeft='8px'; tdRecv.appendChild(recvDate);
      if(x.emit_date){
        var due = addDays(x.emit_date, 2);
        if(due){
          var late = (toDate(x.received_at||todayStr()) - toDate(due)) > 0;
          var note = document.createElement('div'); note.className='note';
          note.textContent = '인수기한: '+due + (late ? ' (지연)' : '');
          tdRecv.appendChild(note);
        }
      }
    }
    tr.appendChild(tdRecv);

    var tdDue = document.createElement('td');
    var dueInput = document.createElement('input');
    dueInput.type='date'; dueInput.value = x.due_date || '';
    dueInput.onchange = function(e){ x.due_date = e.target.value; save(); render(); };
    var canEditDue = (x.role==='processor' || x.role==='both');
    if(!canEditDue){ dueInput.disabled = true; dueInput.title='처리자만 수정 가능'; }
    tdDue.appendChild(dueInput);
    if(!canEditDue){
      var helper = document.createElement('div'); helper.className='note';
      helper.textContent = '역할을 처리업체/운반+처리로 바꾸면 수정 가능';
      tdDue.appendChild(helper);
    }
    tr.appendChild(tdDue);

    var tdProc = document.createElement('td');
    var procWrap = document.createElement('label'); procWrap.style.display='inline-flex'; procWrap.style.alignItems='center'; procWrap.style.gap='6px';
    var proc = document.createElement('input'); proc.type='checkbox'; proc.checked = !!x.processed_done;
    proc.onchange = function(e){ 
      var before = !!x.processed_done;
      x.processed_done = !!e.target.checked; 
      if(x.processed_done){ x.processed_at = x.processed_at || todayStr(); }
      else { x.processed_at = null; }
      save(); render(); 
      if(!before && x.processed_done){
        var line2 = (x.levy_applicable==='해당' && x.completion_date) ? ('준공 후 30일: '+addDays(x.completion_date,30)) : '준공일 입력 시 신고기한 안내';
        showToast([
          '처분부담금: '+(x.levy_applicable||'미확인'),
          line2,
          '건: '+x.title
        ], '처리 완료');
      }
    };
    var procSpan = document.createElement('span'); procSpan.textContent = '처리완료';
    procWrap.appendChild(proc); procWrap.appendChild(procSpan);
    tdProc.appendChild(procWrap);
    tr.appendChild(tdProc);

    var tdApplicable = document.createElement('td');
    var sel = document.createElement('select');
    ['미확인','해당','비해당'].forEach(function(v){ var op=document.createElement('option'); op.value=v; op.textContent=v; sel.appendChild(op); });
    sel.value = x.levy_applicable || '미확인';
    sel.onchange = function(e){ 
      x.levy_applicable = e.target.value; if(x.levy_applicable!=='해당'){ x.levy_done=false; }
      save(); render(); 
    };
    tdApplicable.appendChild(sel);

    if(x.levy_applicable==='해당'){
      var block = document.createElement('div'); block.style.marginTop='6px';
      var lbl = document.createElement('label'); lbl.className='note'; lbl.textContent='준공일';
      var comp = document.createElement('input'); comp.type='date'; comp.style.marginLeft='8px'; comp.value = x.completion_date || '';
      comp.onchange = function(e){ x.completion_date = e.target.value; save(); render(); };
      block.appendChild(lbl); block.appendChild(comp);
      if(x.completion_date){
        var levyDue = addDays(x.completion_date, 30);
        var n = document.createElement('div'); n.className='note'; n.textContent='신고기한(준공+30): '+ (levyDue||'-');
        block.appendChild(n);
      }
      tdApplicable.appendChild(block);
    }
    tr.appendChild(tdApplicable);

    var tdLevy = document.createElement('td');
    var wrap = document.createElement('div'); var disabled = x.levy_applicable!=='해당'; wrap.style.opacity = disabled ? .45 : 1;
    var levy = document.createElement('label'); levy.style.display='inline-flex'; levy.style.alignItems='center'; levy.style.gap='6px';
    var levyBox = document.createElement('input'); levyBox.type='checkbox'; levyBox.checked = !!x.levy_done; levyBox.disabled = disabled;
    levyBox.onchange = function(e){ x.levy_done = !!e.target.checked; x.levy_at = x.levy_done ? (x.levy_at||todayStr()) : null; save(); render(); };
    var levySpan = document.createElement('span'); levySpan.textContent = '신고완료';
    levy.appendChild(levyBox); levy.appendChild(levySpan); wrap.appendChild(levy);
    tdLevy.appendChild(wrap);
    tr.appendChild(tdLevy);

    var tdStatus = document.createElement('td');
    tdStatus.innerHTML = statusText(x);
    tr.appendChild(tdStatus);

    var tdDel = document.createElement('td');
    var del = document.createElement('button'); del.textContent = '삭제'; del.onclick = function(){ STATE = STATE.filter(i=> i.id!==x.id); save(); render(); };
    tdDel.appendChild(del);
    tr.appendChild(tdDel);

    body.appendChild(tr);
  });
}

function statusText(x){
  var recDue = x.emit_date ? addDays(x.emit_date, 2) : null;
  var recDD = (!x.received_done && recDue) ? ddayLabel(recDue) : null;
  var proDD = (!x.processed_done && x.due_date) ? ddayLabel(x.due_date) : null;
  var levyDue = (x.levy_applicable==='해당' && !x.levy_done && x.completion_date) ? addDays(x.completion_date,30) : null;
  var levDD = levyDue ? ddayLabel(levyDue) : null;

  var parts = [];
  if(recDD){ parts.push('<span class="pill">인수 '+recDD+'</span>'); }
  if(proDD){ parts.push('<span class="pill">처리 '+proDD+'</span>'); }
  if(levDD){ parts.push('<span class="pill">부담금 '+levDD+'</span>'); }
  if(!parts.length) parts.push('<span class="muted">-</span>');
  return parts.join(' ');
}

async function checkFile(url){
  try{
    let res = await fetch(url, { method:'HEAD' });
    if(!res.ok){ res = await fetch(url, { method:'GET' }); }
    return res.ok;
  }catch(e){ return false; }
}
async function runDiag(){
  const area = document.getElementById('diagArea');
  area.innerHTML = '<span class="muted">점검 중...</span>';
  const files = [
    ['올바로', 'assets/pdf/allbaro_manual_2025.pdf'],
    ['부담금', 'assets/pdf/levy_booklet_2025.pdf'],
  ];
  const results = await Promise.all(files.map(f => checkFile(f[1])));
  area.innerHTML = files.map((f,i)=> '<span class="chip '+(results[i]?'ok':'err')+'"><b>'+f[0]+'</b> '+(results[i]?'있음 ✅':'없음 ❌')+'</span>').join(' ');
}

function exportJson(){
  if(!CUR_USER){ alert('먼저 사용자 ID를 입력하고 열어주세요.'); return; }
  var blob = new Blob([JSON.stringify({ user: CUR_USER, data: STATE }, null, 2)], {type:'application/json'});
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'route_checker_'+CUR_USER+'_'+new Date().toISOString().slice(0,10)+'.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
async function pullFromServer(){
  if(!CUR_USER){ alert('먼저 사용자 ID를 입력하고 열어주세요.'); return; }
  var url = document.getElementById('apiUrl').value.trim();
  if(!url){ alert('서버 주소를 입력하세요.'); return; }
  try{
    var res = await fetch(url + '?user=' + encodeURIComponent(CUR_USER), { method:'GET' });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    var obj = await res.json();
    if(obj && Array.isArray(obj.data)){ STATE = obj.data; save(); render(); alert('서버에서 불러왔습니다.'); }
    else { alert('서버에 데이터가 없습니다.'); }
  }catch(e){ alert('불러오기 실패: ' + e.message); }
}
async function pushToServer(){
  if(!CUR_USER){ alert('먼저 사용자 ID를 입력하고 열어주세요.'); return; }
  var url = document.getElementById('apiUrl').value.trim();
  if(!url){ alert('서버 주소를 입력하세요.'); return; }
  try{
    var res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ user: CUR_USER, data: STATE }) });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    alert('서버에 저장했습니다.');
  }catch(e){ alert('저장 실패: ' + e.message); }
}

document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('switchUser').addEventListener('click', switchUser);
  document.getElementById('exportBtn').addEventListener('click', exportJson);
  document.getElementById('pullBtn').addEventListener('click', pullFromServer);
  document.getElementById('pushBtn').addEventListener('click', pushToServer);
  document.getElementById('diagBtn').addEventListener('click', runDiag);

  document.getElementById('userId').addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); switchUser(); } });

  var addBtn = document.getElementById('addBtn');
  var title = document.getElementById('titleInput');
  var role = document.getElementById('roleInput');

  function ensureUser(){
    if(CUR_USER) return true;
    var input = document.getElementById('userId');
    var id = (input.value.trim() || 'default');
    CUR_USER = id;
    input.value = id;
    STATE = load(CUR_USER);
    document.getElementById('saveState').textContent = STATE.length ? '로컬 불러옴(자동)' : '신규 사용자(자동)';
    return true;
  }

  function add(){
    ensureUser(); // 자동 사용자 지정
    var v = title.value.trim();
    if(!v){ alert('제목을 입력하세요.'); title.focus(); return; }
    STATE.unshift({
      id: (window.crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-'+Date.now(),
      title: v, role: role.value,
      emit_date: '', received_done:false, received_at:null,
      due_date: '', processed_done:false, processed_at:null,
      levy_applicable:'미확인', completion_date:'', levy_done:false, levy_at:null
    });
    save(); title.value=''; render();
  }

  addBtn.addEventListener('click', add);
  title.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); add(); } });

  render();
});
</script>
</body>
</html>
